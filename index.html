<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Esame Nuoto</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --card-color: #2b2b3d;
            --primary: #3b8ed0;
            --success: #27ae60;
            --warning: #f39c12;
            --error: #e74c3c;
            --text-main: #ffffff;
            --text-muted: #a0a0b0;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; }
        .screen.active { display: flex; }
        
        /* BOTTONI */
        button { border: none; outline: none; border-radius: 15px; font-size: 16px; font-weight: bold; padding: 18px; color: white; cursor: pointer; transition: 0.2s; }
        .btn-success { background-color: var(--success); }
        .btn-primary { background-color: var(--primary); }
        .btn-option { background-color: var(--card-color); text-align: left; font-weight: normal; margin-bottom: 10px; border: 2px solid transparent; }
        .btn-option:active { opacity: 0.7; transform: scale(0.98); }
        
        /* SCHERMATA HOME */
        #home-screen { align-items: center; justify-content: center; text-align: center; }
        .title { font-size: 32px; color: var(--primary); margin-bottom: 10px; }
        
        /* SCHERMATA QUIZ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 16px; font-weight: bold;}
        .progress-bar { height: 8px; background: var(--card-color); border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .question-box { background: var(--card-color); padding: 20px; border-radius: 15px; margin-bottom: 20px; font-size: 19px; line-height: 1.4; overflow-y: auto; max-height: 35vh; }
        .category { color: var(--warning); font-size: 13px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px;}
        .options-container { flex: 1; overflow-y: auto; }
        
        /* NAVIGAZIONE PALLINI */
        .dots-nav { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px; scroll-snap-type: x mandatory;}
        .dot { min-width: 38px; height: 38px; border-radius: 50%; background: var(--card-color); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; scroll-snap-align: center;}
        .dot.current { border: 2px solid white; }
        .dot.correct { background: var(--success); }
        .dot.wrong { background: var(--error); }
    </style>
</head>
<body>

    <!-- SCHERMATA HOME -->
    <div id="home-screen" class="screen active">
        <h1 class="title">Esame Istruttore</h1>
        <p style="color: var(--text-muted); margin-bottom: 50px;">Scegli la modalitÃ  di simulazione</p>
        
        <button class="btn-success" style="width: 100%; margin-bottom: 20px;" onclick="startQuiz(40)">
            ESAME COMPLETO<br><span style="font-size: 13px; font-weight: normal;">40 Domande</span>
        </button>
        
        <button class="btn-primary" style="width: 100%; margin-bottom: 20px;" onclick="startQuiz(10)">
            TEST RAPIDO<br><span style="font-size: 13px; font-weight: normal;">10 Domande</span>
        </button>
    </div>

    <!-- SCHERMATA QUIZ -->
    <div id="quiz-screen" class="screen">
        <div class="header">
            <span id="q-counter">Domanda 1 / X</span>
            <span style="color: var(--error); font-weight: bold;" onclick="finishQuiz()">Termina</span>
        </div>
        
        <div class="dots-nav" id="dots-container"></div>
        
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        
        <div class="question-box">
            <div class="category" id="q-category">Categoria</div>
            <div id="q-text">Testo della domanda...</div>
        </div>
        
        <div class="options-container" id="options-container">
            <!-- Bottoni generati via JS -->
        </div>

        <div style="display: flex; justify-content: space-between; margin-top: 10px; gap: 15px;">
            <button style="flex: 1; background-color: var(--card-color);" onclick="goPrev()">â—€ Precedente</button>
            <button style="flex: 1; background-color: var(--card-color);" onclick="goNext()">Successiva â–¶</button>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let currentQuiz =[];
        let currentIndex = 0;
        let userAnswers = {}; 
        let totalQuestions = 50; // Variabile dinamica

        // Carica il JSON locale
        fetch('domande.json')
            .then(res => res.json())
            .then(data => { allQuestions = data; })
            .catch(err => alert("Errore caricamento file JSON. Controlla il server locale."));

        function startQuiz(numQuestions) {
            if(allQuestions.length < numQuestions) return alert("Database non ancora caricato...");
            
            totalQuestions = numQuestions;
            let shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            currentQuiz = shuffled.slice(0, totalQuestions);
            
            currentIndex = 0;
            userAnswers = {};
            
            buildDots();
            showScreen('quiz-screen');
            loadQuestion();
        }

        function buildDots() {
            const container = document.getElementById('dots-container');
            container.innerHTML = '';
            for(let i=0; i<totalQuestions; i++) {
                let dot = document.createElement('div');
                dot.className = 'dot';
                dot.innerText = i + 1;
                dot.onclick = () => { currentIndex = i; loadQuestion(); };
                container.appendChild(dot);
            }
        }

        function loadQuestion() {
            const q = currentQuiz[currentIndex];
            document.getElementById('q-counter').innerText = `Domanda ${currentIndex + 1} / ${totalQuestions}`;
            document.getElementById('progress-fill').style.width = `${((currentIndex + 1) / totalQuestions) * 100}%`;
            document.getElementById('q-category').innerText = q.categoria;
            document.getElementById('q-text').innerText = q.testo;

            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';

            const hasAnswered = userAnswers[currentIndex] !== undefined;

            q.opzioni.forEach((opt, i) => {
                let letter = String.fromCharCode(65 + i);
                let btn = document.createElement('button');
                btn.className = 'btn-option';
                btn.innerText = opt;
                btn.style.width = "100%";
                
                if (hasAnswered) {
                    if (letter === q.corretta) btn.style.backgroundColor = 'var(--success)';
                    else if (userAnswers[currentIndex] === letter) btn.style.backgroundColor = 'var(--error)';
                    btn.disabled = true;
                } else {
                    btn.onclick = () => selectAnswer(letter);
                }
                
                optsContainer.appendChild(btn);
            });

            updateDots();
        }

        function selectAnswer(letter) {
            userAnswers[currentIndex] = letter;
            loadQuestion(); 

            // Avanzamento automatico
            setTimeout(() => {
                if (currentIndex < totalQuestions - 1) {
                    currentIndex++;
                    loadQuestion();
                } else {
                    finishQuiz(); // Se era l'ultima, mostra i risultati
                }
            }, 600);
        }

        function updateDots() {
            const dots = document.getElementById('dots-container').children;
            for(let i=0; i<totalQuestions; i++) {
                dots[i].className = 'dot';
                if(i === currentIndex) dots[i].classList.add('current');
                
                if(userAnswers[i] !== undefined) {
                    let isCorrect = userAnswers[i] === currentQuiz[i].corretta;
                    dots[i].classList.add(isCorrect ? 'correct' : 'wrong');
                }
            }
            dots[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        function goNext() { if (currentIndex < totalQuestions - 1) { currentIndex++; loadQuestion(); } }
        function goPrev() { if (currentIndex > 0) { currentIndex--; loadQuestion(); } }

        function finishQuiz() {
            let score = 0;
            let answered = Object.keys(userAnswers).length;
            
            if (answered < totalQuestions) {
                if(!confirm(`Hai risposto solo a ${answered} domande su ${totalQuestions}. Vuoi consegnare comunque?`)) return;
            }

            for(let i=0; i<totalQuestions; i++) {
                if (userAnswers[i] === currentQuiz[i].corretta) score++;
            }
            
            let esito = (score / totalQuestions) >= 0.75 ? "ðŸŽ‰ PROMOSSO!" : "âŒ BOCCIATO";
            alert(`Esame Terminato!\n\n${esito}\nPunteggio: ${score} su ${totalQuestions}`);
            showScreen('home-screen');
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>